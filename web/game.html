<html>
	<head>
		<script src="../socket.io/socket.io.js"></script>
		<script>
var canvas;
var ctx;
var socket;
var myPos = {};

function init() {
	canvas = document.getElementById('canvas');
	ctx = canvas.getContext('2d');

	socket = io();
	socket.on('tick', function(msg) {
		document.getElementById('tick').innerHTML = msg;
	});
	socket.on('pos', function(msg) {
		myPos = msg;
	});

	socket.on('map', function(msg) {
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		ctx.fillStyle = 'rgb(0,0,0)';
		for (var i = 0; i < msg.objects.length; ++i) {
			var obj = msg.objects[i];
			ctx.beginPath();
			ctx.arc(obj.x, obj.y, 10, 0, Math.PI * 2, false);
			ctx.fill();
		}

		ctx.strokeStyle = 'rgb(255,255,0)';
		var crossSize = 5;

		ctx.beginPath();
		ctx.moveTo(myPos.x - crossSize, myPos.y);
		ctx.lineTo(myPos.x + crossSize, myPos.y);
		ctx.stroke();

		ctx.beginPath();
		ctx.moveTo(myPos.x, myPos.y - crossSize);
		ctx.lineTo(myPos.x, myPos.y + crossSize);
		ctx.stroke();
	});
}

var keys = {
	87: 'up',
	83: 'down',
	65: 'left',
	68: 'right',
};

document.addEventListener('keydown', function(e) {
	if (keys[e.keyCode]) {
		socket.emit('ctrldown', keys[e.keyCode]);
	}
});
document.addEventListener('keyup', function(e) {
	if (keys[e.keyCode]) {
		socket.emit('ctrlup', keys[e.keyCode]);
	}
});

var gamepadIndex = 0;

var gpButtons = {
	action: 0,
	up: 12,
	down: 13,
	left: 14,
	right: 15,
}
var gpButtonState = {};
function renderLoop() {
	var gamepad = navigator.getGamepads()[gamepadIndex];
	if (gamepad) {
		for (var key in gpButtons) {
			var pressed = gamepad.buttons[gpButtons[key]].value;
			if (gpButtonState[key] && !pressed) {
				socket.emit('ctrlup', key);
			}
			if (!gpButtonState[key] && pressed) {
				socket.emit('ctrldown', key);
			}
			gpButtonState[key] = pressed;
		}
	}
	requestAnimationFrame(renderLoop);
}

requestAnimationFrame(renderLoop);

		</script>
	</head>
	<body onload="init()">
		Tick: <span id="tick">??</span><br/>
		<canvas id="canvas"></canvas>
	</body>
</html>
